name: Merge Blacklist and Whitelist and Convert to Binary

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # 每天 UTC 03:00 执行任务

jobs:
  merge-blacklist-whitelist:
    runs-on: ubuntu-latest

    steps:
      # 检出仓库
      - name: Checkout repo
        uses: actions/checkout@v4

      # 下载黑名单和白名单文件
      - name: Download Lists
        run: |
          echo "Downloading blacklist..."
          curl -sL https://raw.githubusercontent.com/jackszb/AdGuardHome-Filter/main/dist/blocklist.txt -o blacklist.txt

          echo "Downloading whitelists..."
          curl -sL https://raw.githubusercontent.com/jackszb/AdGuardHome-Filter/main/dist/whitelist.txt -o whitelist.txt

      # 合并黑名单和白名单文件
      - name: Merge Blacklist and Whitelist
        run: |
          echo "Merging blacklist and whitelist..."
          cat blacklist.txt whitelist.txt > merged_list.txt

      # 安装 sing-box 并转换为二进制规则集
      - name: Install sing-box
        run: |
          curl -fsSL https://sing-box.app/install.sh | sh

      - name: Convert merged list to binary
        run: |
          sing-box rule-set convert --type adguard --output merged_list.srs merged_list.txt

      # 提交并推送更新
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"

          git add merged_list.txt merged_list.srs
          git commit -m "Auto merge blacklist and whitelist, convert to binary" || echo "Nothing to commit"
          git push
