name: Clean Blacklist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  clean-blacklist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Download Lists
        run: |
          echo "Downloading blacklist..."
          curl -sL https://raw.githubusercontent.com/jackszb/AdGuardHome-Filter/main/dist/blocklist.txt -o blacklist.txt

          echo "Downloading whitelists..."
          mkdir -p whitelist

          # 自由添加白名单
          curl -sL https://raw.githubusercontent.com/jackszb/AdGuardHome-Filter/main/dist/whitelist.txt -o whitelist/allow.txt
          # curl -sL https://example.com/whitelist2.txt -o whitelist/list2.txt

      - name: Write Python Script (safe echo method)
        run: |
          echo "import os" > clean.py
          echo "" >> clean.py
          echo "def load_domains(path):" >> clean.py
          echo "    result = set()" >> clean.py
          echo "    with open(path, 'r', encoding='utf-8') as f:" >> clean.py
          echo "        for line in f:" >> clean.py
          echo "            d = line.strip().lower()" >> clean.py
          echo "            if d:" >> clean.py
          echo "                result.add(d)" >> clean.py
          echo "    return result" >> clean.py
          echo "" >> clean.py
          echo "# Load blacklist" >> clean.py
          echo "blacklist = load_domains('blacklist.txt')" >> clean.py
          echo "" >> clean.py
          echo "# Load all whitelists" >> clean.py
          echo "whitelist = set()" >> clean.py
          echo "for file in os.listdir('whitelist'):" >> clean.py
          echo "    whitelist |= load_domains(os.path.join('whitelist', file))" >> clean.py
          echo "" >> clean.py
          echo "# Remove whitelist domains" >> clean.py
          echo "cleaned = blacklist - whitelist" >> clean.py
          echo "" >> clean.py
          echo "# Sort" >> clean.py
          echo "cleaned_sorted = sorted(cleaned)" >> clean.py
          echo "" >> clean.py
          echo "# Write cleaned domains" >> clean.py
          echo "with open('cleaned_domains.txt', 'w', encoding='utf-8') as f:" >> clean.py
          echo "    for d in cleaned_sorted:" >> clean.py
          echo "        f.write(d + '\\n')" >> clean.py
          echo "" >> clean.py
          echo "# Write AdGuard format" >> clean.py
          echo "with open('adguard.txt', 'w', encoding='utf-8') as f:" >> clean.py
          echo "    for d in cleaned_sorted:" >> clean.py
          echo "        f.write(f'||{d}^\\n')" >> clean.py
          echo "" >> clean.py
          echo "print('黑名单：', len(blacklist))" >> clean.py
          echo "print('白名单：', len(whitelist))" >> clean.py
          echo "print('最终数量：', len(cleaned_sorted))" >> clean.py

      - name: Run Python Script
        run: python3 clean.py

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"

          git add cleaned_domains.txt adguard.txt
          git commit -m "Auto update blacklist + AdGuard format" || echo "Nothing to commit"
          git push
